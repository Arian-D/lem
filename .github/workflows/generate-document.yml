name: Generate document

on:
  push:
    branches: [ '*' ]
  workflow_dispatch:
    branches: [ '*' ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        submodules: true
    - name: Install Roswell
      env:
        LISP: ${{ matrix.lisp }}
      run: |
        curl -L https://raw.githubusercontent.com/roswell/roswell/v22.12.14.113/scripts/install-for-ci.sh | sh
    - name: Generate document and create pull request
      run: |
        set -ex

        # workaround for sbcl and log4cl combination problems
        mkdir ~/common-lisp
        cd ~/common-lisp
        git clone https://github.com/sharplispers/log4cl.git
        cd -

        ros config set dynamic-space-size 2048

        ros install lem-project/async-process lem

        export PATH=$HOME/.roswell/bin:$PATH

        cd $(ros -e '(princ (ql:where-is-system :lem))')
        ros -s lem -s lem/extensions -e '(lem/document:generate-markdown-file "docs/default-bindings.md")'

        if [ -z "$(git diff docs/default-bindings.md)" ]; then
          exit 0
        fi

        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"

        branch_name="update-docs-$(date '+%Y%m%d-%H%M%S')"
        git checkout -b $branch_name
        git add docs/default-bindings.md
        git commit -m 'update docs/default-bindings.md'
        git push origin $branch_name

        gh pr create -B main -t "update docs/default-bindings.md $(date '+%Y%m%d-%H%M%S')" -b ''
